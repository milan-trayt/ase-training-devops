FROM node:20.17.0-alpine3.19

WORKDIR /home/app

ENV NODE_OPTIONS=--max_old_space_size=4096

COPY ["./package.json", "./package-lock.json", "./"]

RUN npm install

COPY . .

ARG REGISTRY_URI
ARG SECRET_PREFIX
ARG AWS_REGION="us-west-2"
ARG DATABASE_URL
ARG AWS_ACCESS_KEY_ID
ARG AWS_SECRET_ACCESS_KEY
ARG AWS_SESSION_TOKEN

ENV NODE_ENV=production
ENV SECRET_PREFIX=${SECRET_PREFIX}
ENV AWS_REGION=${AWS_REGION}
ENV DATABASE_URL=${DATABASE_URL}
ENV AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
ENV AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
ENV AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}

RUN apk add --no-cache bash
RUN apk add --no-cache aws-cli

EXPOSE 3000
CMD ["/bin/bash","entrypoint.sh"]